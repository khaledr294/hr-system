# دليل اختبار نظام الصلاحيات

## التغييرات التي تم تطبيقها

### 1. نظام الصلاحيات الأساسي
تم إنشاء نظام كامل للتحقق من الصلاحيات يعتمد على المسميات الوظيفية (JobTitles) بدلاً من الأدوار الثابتة.

#### الملفات الرئيسية:
- `src/lib/permissions.ts` - دوال التحقق من الصلاحيات الأساسية
- `src/lib/permission-middleware.ts` - دوال مساعدة للصفحات و API
- `src/app/403/page.tsx` - صفحة "عذراً، ليس لديك صلاحية"

### 2. حماية API Endpoints

#### Workers API (`/api/workers`)
- **GET** - يتطلب `VIEW_WORKERS`
- **POST** - يتطلب `CREATE_WORKERS`
- **GET /[id]** - يتطلب `VIEW_WORKERS`
- **PUT /[id]** - يتطلب `EDIT_WORKERS`
- **DELETE /[id]** - يتطلب `DELETE_WORKERS`

#### Contracts API (`/api/contracts`)
- **GET** - يتطلب `VIEW_CONTRACTS`
- **POST** - يتطلب `CREATE_CONTRACTS`
- **PATCH /[id]** - يتطلب `EDIT_CONTRACTS`
- **DELETE /[id]** - يتطلب `DELETE_CONTRACTS`

#### Clients API (`/api/clients`)
- **GET** - يتطلب `VIEW_CLIENTS`
- **POST** - يتطلب `CREATE_CLIENTS`
- **GET /[id]** - يتطلب `VIEW_CLIENTS`
- **PUT /[id]** - يتطلب `EDIT_CLIENTS`
- **DELETE /[id]** - يتطلب `DELETE_CLIENTS`

#### Users API (`/api/users`)
- **POST** - يتطلب `CREATE_USERS`
- **PUT /[id]** - يتطلب `EDIT_USERS`
- **DELETE /[id]** - يتطلب `DELETE_USERS`

### 3. حماية الصفحات

#### صفحة العمال (`/workers`)
- يتطلب صلاحية `VIEW_WORKERS`
- إعادة توجيه تلقائية لصفحة 403 عند عدم وجود الصلاحية

---

## كيفية الاختبار

### الخطوة 1: إنشاء مسمى وظيفي محدود الصلاحيات

1. سجل دخول كـ HR_MANAGER
2. انتقل إلى صفحة المسميات الوظيفية: `/premium/job-titles`
3. أنشئ مسمى وظيفي جديد (مثلاً: "مسوق")
4. امنحه صلاحيات محدودة فقط:
   - ✅ `VIEW_WORKERS` - عرض العمال
   - ✅ `VIEW_CLIENTS` - عرض العملاء
   - ❌ لا تمنح أي صلاحيات أخرى (CREATE, EDIT, DELETE)

### الخطوة 2: إنشاء مستخدم اختبار

1. انتقل إلى صفحة المستخدمين: `/dashboard/users`
2. أنشئ مستخدم جديد:
   - الاسم: `مستخدم اختبار`
   - البريد: `test@example.com`
   - كلمة المرور: `test123`
   - المسمى الوظيفي: اختر المسمى الذي أنشأته في الخطوة 1

### الخطوة 3: اختبار نظام الصلاحيات

1. **تسجيل خروج** من حساب HR_MANAGER
2. **سجل دخول** باستخدام المستخدم الجديد:
   - البريد: `test@example.com`
   - كلمة المرور: `test123`

### الخطوة 4: اختبار عرض البيانات (يجب أن ينجح)

✅ **صفحة العمال** (`/workers`):
- يجب أن تعرض قائمة العمال
- السبب: لديك صلاحية `VIEW_WORKERS`

✅ **صفحة العملاء** (`/clients`):
- يجب أن تعرض قائمة العملاء (إن كانت محمية)
- السبب: لديك صلاحية `VIEW_CLIENTS`

### الخطوة 5: اختبار إنشاء عامل (يجب أن يفشل)

❌ حاول إنشاء عامل جديد:
1. انقر على زر "إضافة عاملة جديدة"
2. املأ البيانات واضغط "حفظ"
3. **النتيجة المتوقعة**: 
   - رسالة خطأ: `403 Forbidden - ليس لديك صلاحية إضافة عمال`
   - السبب: لا تملك صلاحية `CREATE_WORKERS`

### الخطوة 6: اختبار تعديل عامل (يجب أن يفشل)

❌ حاول تعديل عامل موجود:
1. انقر على عامل من القائمة
2. حاول تعديل البيانات
3. **النتيجة المتوقعة**: 
   - رسالة خطأ: `403 Forbidden - ليس لديك صلاحية تعديل العمال`
   - السبب: لا تملك صلاحية `EDIT_WORKERS`

### الخطوة 7: اختبار حذف عامل (يجب أن يفشل)

❌ حاول حذف عامل:
1. انقر على زر الحذف لأي عامل
2. **النتيجة المتوقعة**: 
   - رسالة خطأ: `403 Forbidden - ليس لديك صلاحية حذف العمال`
   - السبب: لا تملك صلاحية `DELETE_WORKERS`

### الخطوة 8: اختبار صفحة غير مصرح بها (يجب أن يفشل)

❌ حاول الوصول لصفحة المستخدمين:
1. اذهب إلى `/dashboard/users`
2. **النتيجة المتوقعة**:
   - إعادة توجيه لصفحة 403
   - رسالة: "غير مصرح بالدخول - ليس لديك الصلاحية للوصول إلى هذه الصفحة"
   - السبب: لا تملك صلاحية `VIEW_USERS`

---

## السيناريوهات المتقدمة

### اختبار المستخدم ذو صلاحيات كاملة

1. سجل دخول كـ HR_MANAGER
2. يجب أن يكون لديك وصول لجميع الصفحات والعمليات
3. السبب: `HR_MANAGER` يملك جميع الصلاحيات تلقائياً

### اختبار تعديل الصلاحيات أثناء تسجيل الدخول

1. سجل دخول كمستخدم محدود الصلاحيات
2. في نافذة أخرى، سجل دخول كـ HR_MANAGER
3. قم بتعديل صلاحيات المستخدم الأول (أضف `CREATE_WORKERS`)
4. في النافذة الأولى، قم بتسجيل خروج ثم دخول مرة أخرى
5. الآن يجب أن تتمكن من إنشاء عمال

---

## نتائج متوقعة

### ✅ يجب أن ينجح:
- عرض البيانات (عمال، عملاء) إذا كان لديك صلاحية VIEW
- تسجيل الدخول والخروج
- الوصول لصفحة Dashboard الرئيسية
- عرض الصفحة الخاصة (Profile) الخاصة بك

### ❌ يجب أن يفشل:
- إنشاء أي بيانات بدون صلاحية CREATE
- تعديل أي بيانات بدون صلاحية EDIT
- حذف أي بيانات بدون صلاحية DELETE
- الوصول لصفحات بدون صلاحية VIEW

---

## استكشاف الأخطاء

### المشكلة: المستخدم لا يزال يستطيع الوصول لكل شيء

**الحلول المحتملة:**
1. تأكد من أن المستخدم ليس `HR_MANAGER` (له صلاحيات كاملة دائماً)
2. تحقق من أن المسمى الوظيفي نشط (`isActive: true`)
3. تأكد من أن الصلاحيات محفوظة بشكل صحيح في قاعدة البيانات
4. سجل خروج ثم دخول مرة أخرى لتحديث الجلسة

### المشكلة: خطأ 401 Unauthorized

**الحلول:**
1. تأكد من تسجيل الدخول
2. تحقق من صلاحية token الخاص بك
3. جرب تسجيل الخروج ثم الدخول مرة أخرى

### المشكلة: خطأ 500 Internal Server Error

**الحلول:**
1. تحقق من console في المتصفح
2. افحص سجلات الخادم (terminal)
3. تأكد من أن قاعدة البيانات متصلة
4. تحقق من أن جميع الحقول مملوءة بشكل صحيح

---

## الخطوات التالية

- [ ] حماية باقي الصفحات (contracts, clients, users, reports)
- [ ] تحديث Sidebar لإخفاء الروابط غير المصرح بها
- [ ] حماية API endpoints الإضافية (archive, backups, logs)
- [ ] إضافة audit logging لتتبع من قام بماذا
- [ ] إضافة permission groups لتبسيط إدارة الصلاحيات
