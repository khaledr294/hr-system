generator client {
  provider   = "prisma-client-js"
  engineType = "accelerate"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Log {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  message   String?
  createdAt DateTime @default(now())
  user      User?    @relation("UserLogs", fields: [userId], references: [id])
}

model Package {
  id        String   @id @default(cuid())
  name      String
  duration  Int
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Worker {
  id                  String             @id @default(cuid())
  name                String
  code                String             @unique
  nationality         String
  residencyNumber     String             @unique
  dateOfBirth         DateTime
  phone               String
  status              String             @default("AVAILABLE")
  salary              Float?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  nationalitySalaryId String?
  arrivalDate         DateTime?
  borderNumber        String?
  iban                String?
  officeName          String?
  passportNumber      String?
  religion            String?
  reservationNotes    String?
  reservedAt          DateTime?
  reservedBy          String?
  residenceBranch     String?
  contracts           Contract[]
  nationalitySalary   NationalitySalary? @relation("NationalityWorkers", fields: [nationalitySalaryId], references: [id])
}

model NationalitySalary {
  id          String   @id @default(cuid())
  nationality String   @unique
  salary      Float
  workers     Worker[] @relation("NationalityWorkers")
}

model JobTitle {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String
  description String?
  permissions String   @default("[]") // JSON array of permissions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]   @relation("UserJobTitle")
}

model User {
  id                   String         @id @default(cuid())
  name                 String         @default("")
  email                String?
  password             String?
  role                 String?        @default("STAFF")
  jobTitleId           String?
  nationality          String?        @default("")
  nationalitySalaryId  String?
  residencyNumber      String?        @unique
  dateOfBirth          DateTime?      @default(now())
  phone                String?        @default("")
  status               String         @default("AVAILABLE")
  salary               Float?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  twoFactorBackupCodes String?
  twoFactorEnabled     Boolean        @default(false)
  twoFactorSecret      String?
  jobTitle             JobTitle?      @relation("UserJobTitle", fields: [jobTitleId], references: [id])
  logs                 Log[]          @relation("UserLogs")
  Notification         Notification[]
  marketedContracts    Contract[]     @relation("UserMarketer")
}

model Client {
  id          String     @id @default(cuid())
  name        String
  phone       String
  email       String?
  address     String
  idNumber    String     @unique
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  dateOfBirth DateTime?
  contracts   Contract[]
}

model Marketer {
  id        String   @id @default(cuid())
  name      String
  phone     String
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contract {
  id             String    @id @default(cuid())
  workerId       String
  clientId       String
  startDate      DateTime
  endDate        DateTime
  packageType    String
  packageName    String?   @default("")
  totalAmount    Float
  status         String    @default("ACTIVE")
  notifiedBefore Boolean   @default(false)
  contractNumber String?   @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  marketerId     String?
  notes          String?   @default("")
  delayDays      Int?      @default(0)
  penaltyAmount  Float?    @default(0)
  penaltyRate    Float?    @default(120)
  client         Client    @relation(fields: [clientId], references: [id])
  marketer       User?     @relation("UserMarketer", fields: [marketerId], references: [id])
  worker         Worker    @relation(fields: [workerId], references: [id])
}

model ArchiveLog {
  id          String   @id
  entityType  String
  entityId    String
  action      String
  performedBy String?
  reason      String?
  metadata    String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
}

model ArchivedContract {
  id             String   @id
  originalId     String   @unique
  workerId       String
  workerName     String
  workerCode     String
  clientId       String
  clientName     String
  startDate      DateTime
  endDate        DateTime
  packageType    String
  packageName    String?
  totalAmount    Float
  status         String
  contractNumber String?
  notes          String?
  delayDays      Int?
  penaltyAmount  Float?
  marketerId     String?
  marketerName   String?
  archivedAt     DateTime @default(now())
  archivedBy     String?
  archiveReason  String   @default("EXPIRED")
  metadata       String?

  @@index([archiveReason])
  @@index([archivedAt])
  @@index([clientId])
  @@index([workerId])
}

model ArchivedWorker {
  id              String   @id
  originalId      String   @unique
  name            String
  code            Int
  nationality     String
  residencyNumber String
  dateOfBirth     DateTime
  phone           String
  status          String
  passportNumber  String?
  salary          Float?
  archivedAt      DateTime @default(now())
  archivedBy      String?
  archiveReason   String   @default("INACTIVE")
  contractsCount  Int      @default(0)
  metadata        String?

  @@index([archiveReason])
  @@index([archivedAt])
}

model Backup {
  id        String   @id
  filename  String
  size      BigInt
  type      String   @default("automatic")
  status    String   @default("in_progress")
  error     String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([status])
}

model Notification {
  id        String   @id
  type      String
  title     String
  message   String
  priority  String   @default("MEDIUM")
  read      Boolean  @default(false)
  userId    String?
  metadata  String?
  link      String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId, read])
}

enum Role {
  ADMIN
  HR
  GENERAL_MANAGER
  MARKETER
  STAFF
}

enum Nationality {
  ETHIOPIA
  UGANDA
  KENYA
  INDONESIA
  BURUNDI
}
