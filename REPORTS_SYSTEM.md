# نظام التقارير المتقدمة - HR System

## نظرة عامة
تم تطوير نظام تقارير متقدم يوفر رؤى شاملة عن العمالة والعقود والعملاء مع إمكانية تصدير Excel لتحليل البيانات.

## المزايا الرئيسية

### 1. أنواع التقارير
- **تقرير العمالة**: إحصائيات شاملة حسب الجنسية والحالة
- **تقرير العقود**: تحليل العقود حسب الحالة والإيرادات
- **تقرير العملاء**: تفاصيل العملاء وإنفاقهم
- **التقرير الشهري**: ملخص شامل للأنشطة الشهرية

### 2. خيارات التصفية
- **فترة زمنية مخصصة**: اختيار من/إلى تاريخ محدد
- **تقارير شهرية**: اختيار سنة وشهر معينين
- **تصفية ديناميكية**: تطبيق فوري للتصفية

### 3. تصدير البيانات
- **Excel Export**: تصدير تقارير العمالة والعقود
- **تنسيق احترافي**: جداول Excel منسقة مع ترويسات
- **بيانات كاملة**: جميع السجلات في ملف واحد

## البنية التقنية

### الملفات الأساسية

#### 1. مكتبة التقارير
```
src/lib/reports.ts (~450 lines)
```
**الوظائف الرئيسية:**
- `generateWorkersReport()`: تقرير العمالة مع تصنيف حسب الجنسية والحالة
- `generateContractsReport()`: تقرير العقود مع حساب الإيرادات
- `generateClientsReport()`: تقرير العملاء مع إجمالي الإنفاق
- `generateMonthlyReport()`: تقرير شهري شامل
- `exportWorkersToExcel()`: تصدير بيانات العمالة
- `exportContractsToExcel()`: تصدير بيانات العقود

**مميزات:**
- استعلامات Prisma محسنة
- حسابات دقيقة للإيرادات والإحصائيات
- دعم التصفية بالتواريخ

#### 2. واجهة API
```
src/app/api/reports/route.ts (86 lines)
```
**النقاط النهائية:**
```typescript
GET /api/reports?type=workers&format=json
GET /api/reports?type=contracts&format=excel
GET /api/reports?type=clients&startDate=2024-01-01&endDate=2024-12-31
GET /api/reports?type=monthly&year=2024&month=11
```

**المعاملات:**
- `type`: نوع التقرير (workers/contracts/clients/monthly)
- `format`: صيغة التقرير (json/excel) - افتراضي: json
- `startDate`, `endDate`: لتصفية الفترة الزمنية
- `year`, `month`: للتقارير الشهرية

#### 3. واجهة المستخدم
```
src/app/(dashboard)/reports/page.tsx (~600 lines)
```
**المكونات:**
- اختيار نوع التقرير مع أيقونات
- فلاتر التاريخ (من/إلى)
- اختيار السنة والشهر للتقارير الشهرية
- عرض الملخص التفاعلي
- جدول التفاصيل (أول 50 سجل)
- أزرار تصدير Excel

**التصميم:**
- دعم Dark Mode كامل
- تصميم Premium responsive
- مؤشرات تحميل
- رسائل خطأ واضحة

### تكامل قاعدة البيانات

#### استعلامات Prisma المحسنة
```typescript
// تقرير العمالة - مع العلاقات
const workers = await prisma.worker.findMany({
  where: dateFilter,
  include: {
    contracts: true
  }
});

// تقرير العقود - مع الحسابات
const contracts = await prisma.contract.findMany({
  where: combinedFilter,
  include: {
    worker: true,
    client: true
  }
});

// تقرير العملاء - مع الإحصائيات
const clients = await prisma.client.findMany({
  include: {
    contracts: {
      include: { worker: true }
    }
  }
});
```

## أنواع التقارير بالتفصيل

### 1. تقرير العمالة
**البيانات المعروضة:**
- إجمالي العمالة
- العمالة المتاحة
- العمالة المتعاقد عليها
- العمالة المحجوزة
- التصنيف حسب الجنسية
- التصنيف حسب الحالة

**التفاصيل:**
- الاسم
- الكود
- الجنسية
- الحالة
- عدد العقود

**تصدير Excel:**
- جدول كامل بجميع البيانات
- تنسيق احترافي مع ترويسات

### 2. تقرير العقود
**البيانات المعروضة:**
- إجمالي العقود
- العقود النشطة
- العقود المنتهية
- العقود المعلقة
- إجمالي الإيرادات

**التفاصيل:**
- اسم العاملة
- اسم العميل
- تاريخ البداية
- تاريخ النهاية
- الحالة
- التكلفة الإجمالية

**تصدير Excel:**
- جدول شامل بجميع العقود
- حساب الإيرادات الإجمالية

### 3. تقرير العملاء
**البيانات المعروضة:**
- إجمالي العملاء
- العملاء مع عقود نشطة
- إجمالي العقود
- إجمالي الإيرادات

**التفاصيل:**
- الاسم
- رقم الجوال
- عدد العقود
- إجمالي المصروفات

### 4. التقرير الشهري
**نظرة شاملة على:**

**العمالة:**
- العمالة المضافة في الشهر
- إجمالي العمالة

**العقود:**
- العقود المُنشأة
- العقود النشطة
- الإيرادات الشهرية

**العملاء:**
- العملاء المضافون
- إجمالي العملاء

## استخدام API

### مثال 1: تقرير العمالة (JSON)
```typescript
const response = await fetch('/api/reports?type=workers');
const data = await response.json();

// data structure:
{
  type: 'workers',
  period: { start: '...', end: '...' },
  summary: {
    total: 150,
    available: 80,
    contracted: 60,
    reserved: 10,
    byNationality: {...},
    byStatus: {...}
  },
  details: [...]
}
```

### مثال 2: تصدير عقود Excel
```typescript
const response = await fetch(
  '/api/reports?type=contracts&format=excel&startDate=2024-01-01&endDate=2024-12-31'
);
const blob = await response.blob();
// تنزيل الملف
```

### مثال 3: تقرير شهري
```typescript
const response = await fetch('/api/reports?type=monthly&year=2024&month=11');
const data = await response.json();

// data structure:
{
  type: 'monthly',
  period: { year: 2024, month: 11 },
  workers: { added: 15, total: 150 },
  contracts: { created: 25, active: 45, revenue: 125000 },
  clients: { added: 8, total: 75 }
}
```

## دعم Dark Mode
- جميع المكونات تدعم الوضع الليلي
- ألوان متناسقة مع التصميم Premium
- تباين واضح للقراءة

## الأمان
- ✅ فحص الصلاحيات (Admin فقط)
- ✅ استعلامات Prisma آمنة
- ✅ التحقق من صحة المعاملات

## الأداء
- استعلامات محسنة مع `include`
- تحميل البيانات حسب الحاجة
- عرض 50 سجل فقط في الواجهة
- Excel يحتوي على جميع البيانات

## الميزات المستقبلية المقترحة
1. **رسوم بيانية**: إضافة Chart.js للتصورات البصرية
2. **تصدير PDF**: إنشاء تقارير PDF منسقة
3. **تقارير مجدولة**: إرسال تقارير أوتوماتيكية بالبريد
4. **تصفية متقدمة**: إضافة مزيد من الفلاتر
5. **مقارنة فترات**: مقارنة أداء شهرين أو أكثر

## إحصائيات الكود
- **src/lib/reports.ts**: ~450 سطر
- **src/app/api/reports/route.ts**: 86 سطر
- **src/app/(dashboard)/reports/page.tsx**: ~600 سطر
- **الإجمالي**: ~1136 سطر

## الاختبار
```bash
# تشغيل السيرفر
npm run dev

# زيارة الصفحة
http://localhost:3000/reports

# اختبار API
curl http://localhost:3000/api/reports?type=workers
```

## الدعم الفني
- **الصلاحيات**: يتطلب دور Admin
- **المتصفحات**: جميع المتصفحات الحديثة
- **الاستجابة**: تصميم responsive كامل

---

**تاريخ الإنشاء**: 2024-11-09  
**الحالة**: ✅ مكتمل وجاهز للاستخدام  
**الإصدار**: 1.0.0
