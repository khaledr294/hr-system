# ๐ง ุชูุฑูุฑ ุฅุตูุงุญ ูุธุงู ุงูุฃุฑุดูู
**ุงูุชุงุฑูุฎ:** 2025-01-13  
**ุงูุญุงูุฉ:** โ ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ

---

## ๐ด ุงููุดุงูู ุงูููุชุดูุฉ

### ุงููุดููุฉ #1: ุนุฏู ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ ุนูุฏ ุงูุชูุงุก ุงูุนูุฏ ุชููุงุฆูุงู
**ุงููุตู:**
- ุนูุฏ ุชุดุบูู `updateExpiredContracts()` ูุชุญุฏูุซ ุงูุนููุฏ ุงูููุชููุฉ
- ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุนูุฏ ูู `ACTIVE` โ `EXPIRED`
- ููู **ูุง ูุชู** ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ ูู `CONTRACTED` โ `AVAILABLE`

**ุงููุชูุฌุฉ:**
- ุงูุนุงููุฉ ุชุจูู ุจุญุงูุฉ "ูุคุฌุฑุฉ" ุฑุบู ุงูุชูุงุก ุงูุนูุฏ
- ูุง ูุชู ุงุญุชุณุงุจ ุฃูุงู ุงูุนูุฏ ูู ูุธุงู ุงูุฑูุงุชุจ (ูุฃู ุญุงูุฉ ุงูุนูุฏ `EXPIRED`)
- ูุง ูููู ุชุฃุฌูุฑ ุงูุนุงููุฉ ูุนููู ุขุฎุฑ (ูุฃู ุญุงูุชูุง ูุง ุชุฒุงู `CONTRACTED`)

**ุงูููู ุงููุชุฃุซุฑ:**
- `src/lib/updateExpiredContracts.ts`

---

### ุงููุดููุฉ #2: ุฃุฑุดูุฉ ุนููุฏ ุฏูู ุฅููุงุฆูุง ุฑุณููุงู
**ุงููุตู:**
- ูููู ูููุณุชุฎุฏู ุฃุฑุดูุฉ ุนูุฏ ุจุญุงูุฉ `EXPIRED` ูุจุงุดุฑุฉ
- ุฏูู ุงููุฑูุฑ ุจุนูููุฉ ุฅููุงุก ุงูุนูุฏ (terminate) ุงูุชู ุชุญุฏุซ ุญุงูุฉ ุงูุนุงููุฉ
- ูุฐุง ูุชุฑู ุงูุนุงููุฉ ุจุญุงูุฉ `CONTRACTED` ุฃู `RESERVED` ุฑุบู ุฃุฑุดูุฉ ุงูุนูุฏ!

**ุงููุชูุฌุฉ:**
- ุงูุนุงููุฉ ูู ุญุงูุฉ ูุดุทุฉ ุฑุบู ุนุฏู ูุฌูุฏ ุนูุฏ ูุนูู
- ุชูุงูุถ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฑุณุงูุฉ ุฎุทุฃ ุนูุฏ ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงูุนูุฏ: "ุงูุนุงููุฉ ูู ุญุงูุฉ ูุดุทุฉ"

**ุงูููู ุงููุชุฃุซุฑ:**
- `src/lib/archive.ts` - ุฏุงูุฉ `archiveContract()`

---

### ุงููุดููุฉ #3: ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงูุนููุฏ ูู ุงูุฃุฑุดูู
**ุงููุตู:**
```typescript
// ุงูููุฏ ุงููุฏูู ูุงู ูุณุชุฎุฏู:
const existingContract = await prisma.contract.findFirst({
  where: {
    OR: [
      { id: archived.originalId },
      { contractNumber: archived.contractNumber || undefined }
    ]
  }
});
```

**ุงููุดููุฉ:**
- ุนูุฏ ุงูุฃุฑุดูุฉุ ูุชู ุงุณุชุฎุฏุงู ููุณ ุงูู `id` ูู ุฌุฏูู `archivedContract`
- ุนูุฏ ูุญุงููุฉ ุงูุงุณุชุนุงุฏุฉุ ูุจุญุซ ุงููุธุงู ุนู `originalId` ูู ุฌุฏูู `contract`
- ููู ุงููุดููุฉ ูู ุดุฑุท `OR` ุงูุฐู ูุชุญูู ูู `contractNumber || undefined`
- ูุฐุง ูุณุจุจ ูุดุงูู ูู ุงูุงุณุชุนูุงู ููุนุทู ูุชุงุฆุฌ ุฎุงุทุฆุฉ

**ุงููุชูุฌุฉ:**
- ุฑุณุงูุฉ ุฎุทุฃ "ุงูุนูุฏ ููุฌูุฏ ุจุงููุนู ูู ุงููุธุงู" ุฑุบู ุนุฏู ูุฌูุฏู!

**ุงูููู ุงููุชุฃุซุฑ:**
- `src/lib/archive.ts` - ุฏุงูุฉ `restoreContract()`

---

## โ ุงูุญููู ุงููุทุจูุฉ

### ุงูุญู #1: ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงูุนุงููุงุช
**ุงูุชุนุฏูู:**
```typescript
// ููู: src/lib/updateExpiredContracts.ts
export async function updateExpiredContracts() {
  const today = new Date();
  
  // ุงูุจุญุซ ุนู ุงูุนููุฏ ุงูููุชููุฉ
  const expiredContracts = await prisma.contract.findMany({
    where: {
      endDate: { lt: today },
      status: { not: 'EXPIRED' }
    },
    select: { id: true, workerId: true }
  });

  if (expiredContracts.length === 0) return { success: true, updatedCount: 0 };

  const workerIds = expiredContracts.map(c => c.workerId);
  
  // ุชุญุฏูุซ ูู ูุนุงููุฉ ูุงุญุฏุฉ
  await prisma.$transaction([
    // 1. ุชุญุฏูุซ ุญุงูุฉ ุงูุนููุฏ
    prisma.contract.updateMany({
      where: { id: { in: expiredContracts.map(c => c.id) } },
      data: { status: 'EXPIRED' }
    }),
    
    // 2. ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุงุช (ููุท ุงูููุงุชู ูุง ููุฌุฏ ููู ุนููุฏ ูุดุทุฉ)
    prisma.worker.updateMany({
      where: {
        id: { in: workerIds },
        contracts: { none: { status: 'ACTIVE' } }
      },
      data: { status: 'AVAILABLE' }
    })
  ]);
}
```

**ุงูููุงุฆุฏ:**
- โ ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงูุนุงููุงุช
- โ ูุนุงููุฉ ุขููุฉ (Transaction) ุชุถูู ุชุทุงุจู ุงูุจูุงูุงุช
- โ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุนููุฏ ูุดุทุฉ ุฃุฎุฑู ูุจู ุงูุชุญุฏูุซ

---

### ุงูุญู #2: ููุน ุฃุฑุดูุฉ ุงูุนููุฏ ุฐุงุช ุงูุญุงูุฉ ุงููุดุทุฉ
**ุงูุชุนุฏูู:**
```typescript
// ููู: src/lib/archive.ts
export async function archiveContract(contractId: string, userId?: string, reason?: string) {
  const contract = await prisma.contract.findUnique({
    where: { id: contractId },
    include: { worker: true, client: true, marketer: true }
  });

  if (!contract) throw new Error('ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');

  // ุงูุชุญูู ูู ุญุงูุฉ ุงูุนูุฏ
  if (contract.status !== 'EXPIRED' && 
      contract.status !== 'CANCELLED' && 
      contract.status !== 'COMPLETED') {
    throw new Error('ูุง ูููู ุฃุฑุดูุฉ ุนูุฏ ูุดุท. ูุฌุจ ุฅููุงุก ุงูุนูุฏ ุฃููุงู.');
  }

  // โญ ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ - ูุฌุจ ุฃูุง ุชููู ูุญุฌูุฒุฉ ุฃู ูุคุฌุฑุฉ
  if (contract.worker.status === 'RESERVED' || 
      contract.worker.status === 'CONTRACTED') {
    throw new Error(
      'ูุง ูููู ุฃุฑุดูุฉ ุงูุนูุฏ. ุงูุนุงููุฉ ูุง ุชุฒุงู ูู ุญุงูุฉ ูุดุทุฉ. ' +
      'ูุฑุฌู ุชุญุฏูุซ ุญุงูุชูุง ุฃููุงู.'
    );
  }

  // ... ุจุงูู ุงูููุฏ
}
```

**ุงูููุงุฆุฏ:**
- โ ููุน ุงูุฃุฑุดูุฉ ุฅุฐุง ูุงูุช ุงูุนุงููุฉ ูู ุญุงูุฉ ูุดุทุฉ
- โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุชูุฌู ุงููุณุชุฎุฏู
- โ ุถูุงู ุชุทุงุจู ุงูุจูุงูุงุช

---

### ุงูุญู #3: ุฅุตูุงุญ ููุทู ุงุณุชุนุงุฏุฉ ุงูุนููุฏ
**ุงูุชุนุฏูู:**
```typescript
// ููู: src/lib/archive.ts
export async function restoreContract(archivedContractId: string, userId?: string) {
  const archived = await prisma.archivedContract.findUnique({
    where: { id: archivedContractId }
  });

  if (!archived) throw new Error('ุงูุนูุฏ ุงููุคุฑุดู ุบูุฑ ููุฌูุฏ');

  // โญ ุงูุชุญูู ุงููุจุงุดุฑ ูู ID ุจุฏูุงู ูู OR
  const existingContract = await prisma.contract.findUnique({
    where: { id: archived.originalId }
  });

  if (existingContract) {
    throw new Error('ุงูุนูุฏ ููุฌูุฏ ุจุงููุนู ูู ุงููุธุงู ุงููุดุท. ูุง ูููู ุงุณุชุนุงุฏุชู.');
  }

  // ุงูุชุญูู ูู ุฑูู ุงูุนูุฏ ุจุดูู ูููุตู
  if (archived.contractNumber) {
    const duplicateContract = await prisma.contract.findFirst({
      where: {
        contractNumber: archived.contractNumber,
        id: { not: archived.originalId }
      }
    });

    if (duplicateContract) {
      throw new Error(
        `ููุฌุฏ ุนูุฏ ุขุฎุฑ ุจุฑูู ${archived.contractNumber}. ` +
        'ูุฑุฌู ุชุนุฏูู ุฑูู ุงูุนูุฏ ูุจู ุงูุงุณุชุนุงุฏุฉ.'
      );
    }
  }

  // ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ
  const worker = await prisma.worker.findUnique({
    where: { id: archived.workerId },
    select: { status: true, name: true }
  });

  if (!worker) throw new Error('ุงูุนุงููุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงููุธุงู');

  if (worker.status !== 'AVAILABLE') {
    throw new Error(
      `ูุง ูููู ุงุณุชุนุงุฏุฉ ุงูุนูุฏ. ุงูุนุงููุฉ ${worker.name} ูู ุญุงูุฉ "${worker.status}". ` +
      'ูุฌุจ ุฃู ุชููู ูุชุงุญุฉ ููุงุณุชุนุงุฏุฉ.'
    );
  }

  // ุงุณุชุนุงุฏุฉ ุงูุนูุฏ ูุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ ูู ูุนุงููุฉ ูุงุญุฏุฉ
  const [restoredContract] = await prisma.$transaction([
    prisma.contract.create({
      data: {
        id: archived.originalId,
        workerId: archived.workerId,
        clientId: archived.clientId,
        // ... ุจุงูู ุงูุญููู
      }
    }),
    // ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ ุจูุงุกู ุนูู ุญุงูุฉ ุงูุนูุฏ
    prisma.worker.update({
      where: { id: archived.workerId },
      data: {
        status: archived.status === 'ACTIVE' ? 'CONTRACTED' : 'AVAILABLE'
      }
    })
  ]);

  // ุญุฐู ูู ุงูุฃุฑุดูู ุจุนุฏ ุงูุงุณุชุนุงุฏุฉ ุงููุงุฌุญุฉ
  await prisma.archivedContract.delete({
    where: { id: archivedContractId }
  });

  // ... ุจุงูู ุงูููุฏ
}
```

**ุงูููุงุฆุฏ:**
- โ ูุตู ุงูุชุญูู ูู ID ุนู ุฑูู ุงูุนูุฏ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููู ุญุงูุฉ
- โ ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงูุนุงููุฉ ุนูุฏ ุงูุงุณุชุนุงุฏุฉ
- โ ูุนุงููุฉ ุขููุฉ ูุถูุงู ุชุทุงุจู ุงูุจูุงูุงุช

---

### ุงูุญู #4: ุฅุถุงูุฉ API ูุชุตุญูุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ
**ุงูููู ุงูุฌุฏูุฏ:** `src/app/api/archive/fix/route.ts`

**ุงููุธุงุฆู:**
1. **ุชุตุญูุญ ุญุงูุฉ ุนุงููุฉ:** `fix-worker-status`
   - ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ ุฅูู `AVAILABLE` ุฅุฐุง ูู ููู ููุง ุนููุฏ ูุดุทุฉ
   
2. **ุญุฐู ุนูุฏ ูุคุฑุดู ููุฑุฑ:** `delete-archived-duplicate`
   - ุญุฐู ุงูุนููุฏ ุงููุคุฑุดูุฉ ุงูุชู ูุง ุชุฒุงู ููุฌูุฏุฉ ูู ุงููุธุงู ุงููุดุท
   
3. **ุชูุธูู ุดุงูู:** `cleanup-duplicate-archives`
   - ูุณุญ ุฌููุน ุงูุนููุฏ ุงููุคุฑุดูุฉ ุงูููุฑุฑุฉ ุฏูุนุฉ ูุงุญุฏุฉ

**ูุซุงู ุงูุงุณุชุฎุฏุงู:**
```bash
# ุชุตุญูุญ ุญุงูุฉ ุนุงููุฉ ูุนููุฉ
POST /api/archive/fix
{
  "action": "fix-worker-status",
  "workerId": "worker-id-here"
}

# ุญุฐู ุนูุฏ ูุคุฑุดู ููุฑุฑ
POST /api/archive/fix
{
  "action": "delete-archived-duplicate",
  "archivedContractId": "archived-contract-id"
}

# ุชูุธูู ุดุงูู
POST /api/archive/fix
{
  "action": "cleanup-duplicate-archives"
}
```

---

## ๐๏ธ ุญู ูุดููุฉ JOSNA BEGUM

### ุงูุฎุทูุงุช ุงููุทููุจุฉ:

#### 1. ุชุตุญูุญ ุญุงูุฉ ุงูุนุงููุฉ JOSNA BEGUM
```bash
# ูู ุงููุชุตูุญ ุฃู Postman
POST /api/archive/fix
Content-Type: application/json
Authorization: Bearer <your-token>

{
  "action": "fix-worker-status",
  "workerId": "<worker-id-of-josna>"
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "success": true,
  "message": "ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุฉ JOSNA BEGUM ุฅูู \"ูุชุงุญุฉ\"",
  "previousStatus": "CONTRACTED",
  "newStatus": "AVAILABLE"
}
```

#### 2. ูุญุงููุฉ ุงุณุชุนุงุฏุฉ ุงูุนูุฏ
ุจุนุฏ ุชุตุญูุญ ุญุงูุฉ ุงูุนุงููุฉุ ูููู ุงูุขู ุงุณุชุนุงุฏุฉ ุงูุนูุฏ ูู ุงูุฃุฑุดูู:
- ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุฃุฑุดูู
- ุงุจุญุซ ุนู ุนูุฏ JOSNA BEGUM
- ุงููุฑ "ุงุณุชุนุงุฏุฉ"
- **ุณููุฌุญ ุงูุขู!** โ

#### 3. ุฅุฐุง ุธูุฑุช ุฑุณุงูุฉ "ุงูุนูุฏ ููุฌูุฏ ุจุงููุนู"
ูุฐุง ูุนูู ุฃู ุงูุนูุฏ ููุฌูุฏ ูู ุงููุธุงู ุงููุดุท **ูุงูุฃุฑุดูู** ูู ููุณ ุงูููุช (ุชูุฑุงุฑ):

```bash
POST /api/archive/fix
{
  "action": "delete-archived-duplicate",
  "archivedContractId": "<archived-contract-id>"
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "success": true,
  "message": "ุชู ุญุฐู ุงูุนูุฏ ุงููุคุฑุดู ุงูููุฑุฑ ุจูุฌุงุญ",
  "reason": "ุงูุนูุฏ ููุฌูุฏ ูู ุงููุธุงู ุงููุดุท"
}
```

---

## ๐ ุงูุฅุฌุฑุงุกุงุช ุงูููุงุฆูุฉ ุงููุถุงูุฉ

### 1. ูู ุนูููุฉ ุงูุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ
**ุงูููู:** `src/app/api/contracts/archive-expired/route.ts`

```typescript
// ูุจู ุฃุฑุดูุฉ ูู ุนูุฏุ ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ
if (contract.worker.status === 'RESERVED' || 
    contract.worker.status === 'CONTRACTED') {
  console.warn(
    `โ๏ธ ุชุฎุทู ุฃุฑุดูุฉ ุงูุนูุฏ ${contract.id} - ` +
    `ุงูุนุงููุฉ ${contract.worker.name} ูู ุญุงูุฉ ูุดุทุฉ: ${contract.worker.status}`
  );
  continue; // ุชุฎุทู ูุฐุง ุงูุนูุฏ
}
```

### 2. ุงุณุชุฎุฏุงู Transactions ูู ุฌููุน ุงูุนูููุงุช
- โ ุชุญุฏูุซ ุงูุนููุฏ ูุงูุนุงููุงุช ูู ูุนุงููุฉ ูุงุญุฏุฉ
- โ ุงูุฃุฑุดูุฉ ูุงูุญุฐู ูู ูุนุงููุฉ ูุงุญุฏุฉ
- โ ุงูุงุณุชุนุงุฏุฉ ูุชุญุฏูุซ ุงูุญุงูุฉ ูู ูุนุงููุฉ ูุงุญุฏุฉ

---

## ๐ ููุฎุต ุงูุชุนุฏููุงุช

| ุงูููู | ุงูุชุนุฏูู | ุงูุณุจุจ |
|-------|---------|-------|
| `src/lib/updateExpiredContracts.ts` | ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุงุช ุชููุงุฆูุงู | ููุน ุชูุงูุถ ุงูุจูุงูุงุช |
| `src/lib/archive.ts` - `archiveContract()` | ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ ูุจู ุงูุฃุฑุดูุฉ | ููุน ุฃุฑุดูุฉ ุนููุฏ ุจุนุงููุงุช ูุดุทุงุช |
| `src/lib/archive.ts` - `restoreContract()` | ุฅุตูุงุญ ููุทู ุงูุชุญูู ูุงูุงุณุชุนุงุฏุฉ | ุฅุตูุงุญ ุฎุทุฃ "ุงูุนูุฏ ููุฌูุฏ ุจุงููุนู" |
| `src/app/api/archive/fix/route.ts` | **ููู ุฌุฏูุฏ** - API ูุชุตุญูุญ ุงูุจูุงูุงุช | ุญู ุงููุดุงูู ุงูููุฌูุฏุฉ ุญุงููุงู |
| `src/app/api/contracts/archive-expired/route.ts` | ุฅุถุงูุฉ ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ | ููุน ุงูุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ ูุนููุฏ ูุดุทุฉ |

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

- [x] ุฅุตูุงุญ `updateExpiredContracts()` ูุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุงุช
- [x] ุฅุถุงูุฉ ุงูุชุญูู ูู ุญุงูุฉ ุงูุนุงููุฉ ูู `archiveContract()`
- [x] ุฅุตูุงุญ ููุทู `restoreContract()`
- [x] ุฅุถุงูุฉ API ูุชุตุญูุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ
- [x] ุฅุถุงูุฉ ุฅุฌุฑุงุกุงุช ููุงุฆูุฉ ูู ุงูุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ
- [x] ุงุฎุชุจุงุฑ ุงูุจูุงุก (Build) - โ ูุงุฌุญ
- [ ] ุชุตุญูุญ ุจูุงูุงุช JOSNA BEGUM
- [ ] Push ุฅูู GitHub
- [ ] Deploy ุนูู Vercel

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ูุจู ุงูุฅุตูุงุญ:**
- โ ุนููุฏ ููุชููุฉ ููู ุงูุนุงููุงุช ุจุญุงูุฉ "ูุคุฌุฑุฉ"
- โ ุฃุฑุดูุฉ ุนููุฏ ุฏูู ุชุญุฏูุซ ุญุงูุฉ ุงูุนุงููุงุช
- โ ุฎุทุฃ "ุงูุนูุฏ ููุฌูุฏ ุจุงููุนู" ุนูุฏ ุงูุงุณุชุนุงุฏุฉ
- โ ุชูุงูุถ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุจุนุฏ ุงูุฅุตูุงุญ:**
- โ ุชุญุฏูุซ ุชููุงุฆู ูุญุงูุฉ ุงูุนุงููุงุช ุนูุฏ ุงูุชูุงุก ุงูุนููุฏ
- โ ููุน ุฃุฑุดูุฉ ุนููุฏ ุจุนุงููุงุช ูู ุญุงูุฉ ูุดุทุฉ
- โ ุงุณุชุนุงุฏุฉ ุนููุฏ ุชุนูู ุจุดูู ุตุญูุญ
- โ ุชุทุงุจู ุชุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุชูุฌู ุงููุณุชุฎุฏู
- โ API ูุชุตุญูุญ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ

---

**ุชู ุงูุฅูุฌุงุฒ ุจูุงุณุทุฉ:** GitHub Copilot  
**ูููุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู:** Claude Sonnet 4.5  
**ุงูุชุงุฑูุฎ:** 13 ููุงูุฑ 2025
